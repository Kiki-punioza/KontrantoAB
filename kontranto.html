<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static',filename='styles.css') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static',filename='favicon.ico') }}">
  <title>Igra</title>
  <style>
    svg{
      cursor: pointer;
    }
  </style>
 
</head>

<body oncontextmenu="return false;">
<div class="centered">
  <div style="display: flex; flex-direction: row; margin-bottom: 50px;">
  <svg height="100" width="100" xmlns="http://www.w3.org/2000/svg" id="circle">
    <circle cx="50" cy="50" r="47" stroke="black" stroke-width="3" fill="grey" />
  </svg>

  <svg height="100" width="100" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="50,3 97,97 3,97" stroke="black" stroke-width="3" fill="grey" />
  </svg>
</div>
  <button class="actionButton" id="confirmFirst" style="float:right;" disabled>üö´</button>

  <script src="https://cdn.socket.io/4.8.1/socket.io.min.js" integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+" crossorigin="anonymous"></script>



 <!-- <div id="gameGrid"></div>
  <div>

  <button class="actionButton" id="giveUp" style="float:left;">üè≥Ô∏è</button>

  <button class="actionButton id="confirmMove" style="float:right;">‚úÖ</button>
</div>-->

</div>

</body>
<script>



 // _    _ _____   ____ __________  _____   ____  _____  ______ _   _      _ ______ _ _ 
 //| |  | |  __ \ / __ \___  / __ \|  __ \ / __ \|  __ \|  ____| \ | |    | |  ____| | |
 //| |  | | |__) | |  | | / / |  | | |__) | |  | | |__) | |__  |  \| |    | | |__  | | |
 //| |  | |  ___/| |  | |/ /| |  | |  _  /| |  | |  _  /|  __| | . ` |_   | |  __| | | |
 //| |__| | |    | |__| / /_| |__| | | \ \| |__| | | \ \| |____| |\  | |__| | |____|_|_|
 // \____/|_|     \____/_____\____/|_|  \_\\____/|_|  \_\______|_| \_|\____/|______(_|_)
 //
 //
 // sve ove funkcije su samo za PRVI KORAK!!!
 // treba smisliti GENERALIZIRANE FUNKCIJE PRIDONO≈†ENJA KORAKA KONTRANTU, k?
 // 
 //_______ ____  _____   ____  
 //|__   __/ __ \|  __ \ / __ \ 
 //   | | | |  | | |  | | |  | |
 //   | | | |  | | |  | | |  | |
 //   | | | |__| | |__| | |__| |
 //   |_|  \____/|_____/ \____/ 
 //                             
 // GFPKK ^
 // popraviti svg figura (nisu centrirane)
 // timer za oba igraƒça koji se mo≈æe zaustavit i zapoƒçet na neki emit od glavnog hivemind servera (kad ADVERSARY po≈°alje pokret da na MOM ekranu stanje NJEGOV timer)
 // IZVANREDNI KORAK I DIDSS!!!
 // zapravo napravit igru
 // to je to :>                             




                                                                                      
                                                                                      



  vrijeme1 = new Date();

  const socket = io()

  const gameId = "{{ id }}";
  console.log(gameId);
  const isAdversary = localStorage.getItem('isAdversary');
  console.log(isAdversary);
  let  circle  =  document.     getElementById("circle")   ;
  let triangle =  document.    getElementById("triangle")  ;
  let  button  =  document.  getElementById("confirmFirst");

  let selectedPiece;
  let moves = [];
  let whitePlayer;
  let blackPlayer;
  let selected;
  
  circle.addEventListener('click', () => {
     circle.   innerHTML   =    '<circle cx="50" cy="50" r="47" stroke="black" stroke-width="3" fill="#ccc" />'   ;
    triangle.  innerHTML   =    '<polygon points="50,3 97,97 3,97" stroke="black" stroke-width="3" fill="grey" />';

    selected = 0;
    button.disabled = false;
    button.innerHTML = '‚úÖ';

  });


  triangle.addEventListener('click', () =>{
     circle.   innerHTML   =    '<circle cx="50" cy="50" r="47" stroke="black" stroke-width="3" fill="grey" />'   ;
    triangle.  innerHTML   =    '<polygon points="50,3 97,97 3,97" stroke="black" stroke-width="3" fill="#ccc" />';

    selected = 1;
    button.disabled = false;
    button.innerHTML = '‚úÖ';



  });


  button.addEventListener('click', () => {
    // TODO: napravti igur
    vrijeme2 = new Date();
    var selectedElement;
    socket.emit("firstMove",{"id":gameId,"move":selected,"isAdversary":isAdversary,"moveTime":vrijeme2 - vrijeme1})
    console.log("kliknuo njesra");
    socket.on("recieved", (data) => {

      vrijeme2 = new Date();
      console.log("MEƒåAO")
      console.log(data.isBlack);
      const isBlack = data.isBlack;

      var illegalMoves = isBlack ? ["7", "8", "9", "14", "15", "16", "21", "22", "23"] : ["11", "12", "13", "18", "19", "20", "25", "26", "27"];
      var isFirstMove = true;
      var allowedMoves;
      var a = 0;

      

      blackPlayer = isBlack ? "{{ session['user'] }}" : data.otherPlayer;
      whitePlayer = isBlack ? data.otherPlayer : "{{ session['user'] }}";
      const  blackCircle  =   `
  <svg height="76" class="piece" width="76" xmlns="http://www.w3.org/2000/svg" id="circle">
    <circle cx="38" cy="38" r="35" stroke="white" stroke-width="3" fill="black" />
  </svg>

    `
      const blackTriangle =   `
  <svg height="76" class="piece" width="76" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="38,3 73,73 3,73" stroke="white" stroke-width="3" fill="black" />
  </svg>
    `

      const  whiteCircle  =   `
  <svg height="76" class="piece" width="76" xmlns="http://www.w3.org/2000/svg" id="circle">
    <circle cx="38" cy="38" r="35" stroke="black" stroke-width="3" fill="white" />
  </svg>

    `
      const whiteTriangle =   `
  <svg height="76" class="piece" width="76" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="38,3 73,73 3,73" stroke="black" stroke-width="3" fill="white" />
  </svg>
    `


      newhtml = `
      <div class="centered">
        <div>
        <div style="display:flex;width:100%;justify-content: space-between;"> 
          <div>
            <img class="gameProfile" src="/image/${whitePlayer}">
            ${whitePlayer}
            </div>
          
          <div>
            ${blackPlayer}
            <img class="gameProfile" src="/image/${blackPlayer}">
            </div>
          </div>
       <div id="gameGrid"></div>
       <div id="initialPieces" style="display:flex;width:100%;justify-content: center; gap:10px;"></div>
       </div>
  <div style="display: flex;flex-direction: row;gap: 66px;">

  <button class="actionButton" id="giveUp" style="float:left;">üè≥Ô∏è</button>

  <button class="actionButton" id="confirmMove" style="float:right; disabled">üö´</button>
</div></div>
`;
  document.body.innerHTML = newhtml;
  var confirmButton = document.getElementById("confirmMove");
  var giveUpButton = document.getElementById("giveUp");

const gridDisplay = document.getElementById("gameGrid");  
let initialPieces = document.getElementById("initialPieces");

  
    initialPieces.innerHTML= (isBlack ? blackCircle : whiteCircle).repeat(2)+ (isBlack ? blackTriangle : whiteTriangle).repeat(2);
    

  


for (let i = 0; i < 35; i++) {
      
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.id = ''+i;
        if (["7", "8", "9", "14", "15", "16", "21", "22", "23"].includes(""+i)) {
          cell.classList.add("restricted-left");
        }
        if (["11", "12", "13", "18", "19", "20", "25", "26", "27"].includes(""+i)) {
          cell.classList.add("restricted-right");
        }


        gridDisplay.appendChild(cell);
      

    }

    submitMove = function(){
        //TODO: napravit 

      }

    colorAllowedMoves = function(moves){
      console.log(moves);
      console.log("OVO SU POKRETI");
        for (var id of moves){
          //id = id.padStart(2,"0");
          console.log(id);
          console.log("OVO JE ID");
          console.log(document.getElementById(id));
          document.getElementById(id).style="border: 3px solid #090;";

        }
      }

      computeAllowedMoves = function(position=0){
        let allowedMoves = [];
        if (isFirstMove){
          console.log(illegalMoves);
          console.log("OVO SU NEDOZVOLJENI");
          
          for (let i = 0; i < 35; i++){
            if (illegalMoves.includes(i.toString()) == false){
              console.log(i);
              console.log("OVAJ MERE");
              allowedMoves.push(i.toString());
              
            }
          }
          
        }
        else {
          let allowedMoves = [];
          let transforms = 
        [
          -6,-5,-4,
          -1, 0, 1,
           4, 5, 6,
        ]
          
          for (let i = 0; i<9; i++){
            if(position+transforms[i] > -1 && position+transforms[i] < 35 ){ // && jo≈° toga ali kasnije
              allowedMoves.push(i.toString());
              
            }
          }

        }
        return allowedMoves;
      }


      updateBoard = function(){
        for (var move of moves){
          var pieceCell = document.getElementById(move[1]);
          if (move[0] == "circle"){
              isBlack ? pieceCell.innerHTML = blackCircle : pieceCell.innerHTML = whiteCircle;
          }
          else{
            isBlack ? pieceCell.innerHTML = blackTriangle : pieceCell.innerHTML = whiteTriangle;
          }
        }
      }

      clearSelections = function(){
        for (i = 0; i < 35; i++){
          document.getElementById(i.toString()).style = "";
        }
      }

      //ovo radi
      document.querySelectorAll(".piece").forEach(element => {
        element.addEventListener("click", () =>{
          console.log(`KLIKNUO SAM NA ${element.id}`);
          if (selectedElement !== undefined){
            console.log("SELECTED VEƒÜ POSTOJI");
            console.log(selectedElement.innerHTML);
            selectedElement.innerHTML = selectedElement.innerHTML.replace('<rect width="76" height="76" fill="#ef9"></rect>',"");
            
          }
          selectedElement = element;
          selectedPiece = element.id;
          element.innerHTML = '<rect width="76" height="76" fill="#ef9"></rect>'+element.innerHTML;
          colorAllowedMoves(computeAllowedMoves());
        });
      });

      document.querySelectorAll(".cell").forEach(element => {
        element.addEventListener("click", () => {
          console.log("klikitis");
          console.log(element.id);
          if (selectedElement !== undefined && computeAllowedMoves().includes(element.id)){
          moves.push([selectedPiece,element.id]);
          illegalMoves.push(element.id);
          clearSelections();
          updateBoard();
          a++;
          if (a == 4){
            confirmButton.innerHTML = "‚úÖ";
            confirmButton.disabled = false;
          }
          selectedElement.remove();
          selectedElement = undefined;
          selectedPiece = undefined;
          }
        });
      });

    });

  });


</script>
<!--<script src="{{ url_for('static',filename='kontranto.js') }}"></script>
-->
</html>