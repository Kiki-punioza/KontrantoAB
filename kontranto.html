<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <link rel="stylesheet" href="{{ url_for('static',filename='styles.css') }}">
  <link rel="icon" type="image/x-icon" href="{{ url_for('static',filename='favicon.ico') }}">
  <title>Igra</title>
  <style>
    svg{
      cursor: pointer;
    }
    @media (max-aspect-ratio: 1/1){
    html
{
  transform: scale(0.8);
}
    }
  </style>
 
</head>
<script 
src="https://cdn.socket.io/4.8.1/socket.io.min.js" 
integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
crossorigin="anonymous">
</script>
<script>
      function closePopup(){
  document.getElementById("popup").style.display = "none";
  window.location.href = "/play";
}
    function revenge(){
      document.getElementById("revengeText").innerHTML = "Tra≈æili ste revan≈æ...";
      socket.emit("revenge",{"id":gameId,"isBlack":isBlack});
    }
</script>
<body oncontextmenu="return false;">
<div class="centered">
  <div style="display: flex; flex-direction: row; margin-bottom: 50px;">
  <svg height="100" width="100" xmlns="http://www.w3.org/2000/svg" id="circle">
    <circle cx="50" cy="50" r="47" stroke="black" stroke-width="3" fill="grey" />
  </svg>

  <svg height="100" width="100" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="50,3 97,97 3,97" stroke="black" stroke-width="3" fill="grey" />
  </svg>
</div>
  <button class="actionButton" id="confirmFirst" style="float:right;" disabled>üö´</button>





 <!-- <div id="gameGrid"></div>
  <div>

  <button class="actionButton" id="giveUp" style="float:left;">üè≥Ô∏è</button>

  <button class="actionButton id="confirmMove" style="float:right;">‚úÖ</button>
</div>-->

</div>

</body>
<script>



 // _    _ _____   ____ __________  _____   ____  _____  ______ _   _      _ ______ _ _ 
 //| |  | |  __ \ / __ \___  / __ \|  __ \ / __ \|  __ \|  ____| \ | |    | |  ____| | |
 //| |  | | |__) | |  | | / / |  | | |__) | |  | | |__) | |__  |  \| |    | | |__  | | |
 //| |  | |  ___/| |  | |/ /| |  | |  _  /| |  | |  _  /|  __| | . ` |_   | |  __| | | |
 //| |__| | |    | |__| / /_| |__| | | \ \| |__| | | \ \| |____| |\  | |__| | |____|_|_|
 // \____/|_|     \____/_____\____/|_|  \_\\____/|_|  \_\______|_| \_|\____/|______(_|_)
 //
 //
 // sve ove funkcije su samo za PRVI KORAK!!!
 // treba smisliti GENERALIZIRANE FUNKCIJE PRIDONO≈†ENJA KORAKA KONTRANTU, k?
 // 
 //_______ ____  _____   ____  
 //|__   __/ __ \|  __ \ / __ \ 
 //   | | | |  | | |  | | |  | |
 //   | | | |  | | |  | | |  | |
 //   | | | |__| | |__| | |__| |
 //   |_|  \____/|_____/ \____/ 
 //                      
 // osmisliti naƒçin da igra zapravo radi ?!?!?=I!#?=!#?!#"?)!" 
 //        
 // GFPKK ^
 // popraviti svg figura (nisu centrirane)
 // timer za oba igraƒça koji se mo≈æe zaustavit i zapoƒçet na neki emit od glavnog hivemind servera 
 // (kad ADVERSARY po≈°alje pokret da na MOM ekranu stanje NJEGOV timer)
 //
 // IZVANREDNI KORAK I DIDSS!!!
 // zapravo napravit igru
 // to je to :>                             
 var isFirstMove = true;

 var nameLeft;
 var nameRight;
  movesOfPieces = [];
  vrijeme1 = new Date();

  const socket = io()

  const gameId = "{{ id }}";
  console.log(gameId);
  
  isAdversary = localStorage.getItem('isAdversary');

  console.log(isAdversary);
  let  circle  =  document.     getElementById("circle")   ;
  let triangle =  document.    getElementById("triangle")  ;
  let  button  =  document.  getElementById("confirmFirst");

  let selectedPiece;
  let moves = [[-2,-2,-2,-2],[-2,-2,-2,-2]];
  let whitePlayer;
  let blackPlayer;
  let selected;
  
  circle.addEventListener('click', () => {
     circle.   innerHTML   =    '<circle cx="50" cy="50" r="47" stroke="black" stroke-width="3" fill="#ccc" />'   ;
    triangle.  innerHTML   =    '<polygon points="50,3 97,97 3,97" stroke="black" stroke-width="3" fill="grey" />';

    selected = 0;
    button.disabled = false;
    button.innerHTML = '‚úÖ';

  });


  triangle.addEventListener('click', () =>{
     circle.   innerHTML   =    '<circle cx="50" cy="50" r="47" stroke="black" stroke-width="3" fill="grey" />'   ;
    triangle.  innerHTML   =    '<polygon points="50,3 97,97 3,97" stroke="black" stroke-width="3" fill="#ccc" />';

    selected = 1;
    button.disabled = false;
    button.innerHTML = '‚úÖ';



  });

    var isBlack;
    var selectedElement;

    var timerLeft = { value: 0, isRunning: false, isRight: false, intervalId: null};
    var timerRight = { value: 0, isRunning: false, isRight: true, intervalId: null};

  button.addEventListener('click', () => {


    function formatTime(seconds) {
        //console.log(seconds);
      const minutes = Math.floor(seconds / 60);
      const remainingSeconds = seconds % 60;
      //ovo je NaN
      //molim lijepo popravi
      //console.log(`${minutes}:${remainingSeconds}`);

      return `${String(minutes).padStart(1, "0")}:${String(remainingSeconds).padStart(2, "0")}`;
}


    function startTimer(timer) {
        console.log(`startao sam timer ${timer.isRight}`);
  if (!timer.isRunning) {
    timer.isRunning = true;
    timer.intervalId = setInterval(() => {
      timer.value++;
      document.getElementById(timer.isRight ? "true" : "false").innerText = formatTime(timer.value);
    }, 1000);
  }
}

      function stopTimer(timer) {
  if (timer.isRunning) {
    clearInterval(timer.intervalId);
    
    timer.isRunning = false;
  }
}




    // TODO: napravti igur
    button.disabled = true;
    button.innerHTML = 'üö´';
    vrijeme2 = new Date();
    var selectedId;
    socket.emit("firstMove",{"id":gameId,"move":selected,"isAdversary":isAdversary,"moveTime":Math.round(vrijeme2 - vrijeme1)})
    
    console.log("kliknuo njesra");
    socket.on("recieved", (data) => {

      

      

      vrijeme2 = new Date();
      console.log("MEƒåAO")
      console.log(data.isBlack);
      isBlack = data.isBlack;
      





     // ovo tu slu≈æi za kad je drugi gotov, iza≈°ao ili predao se

      var illegalMoves = isBlack ? ["7", "8", "9", "14", "15", "16", "21", "22", "23"] :
                                   ["11", "12", "13", "18", "19", "20", "25", "26", "27"];
      
      var allowedMoves;
      var a = 0;

      doingSomething = false;

      blackPlayer = isBlack ? "{{ session['user'] }}" : data.otherPlayer;
      whitePlayer = isBlack ? data.otherPlayer : "{{ session['user'] }}";
      const  K  =   `
  <svg height="76" class="piece black" width="76" xmlns="http://www.w3.org/2000/svg" id="circle">
    <circle cx="38" cy="38" r="35" stroke="white" stroke-width="3" fill="black" />
  </svg>

    `
      const T =   `
  <svg height="76" class="piece black" width="76" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="38,3 73,73 3,73" stroke="white" stroke-width="3" fill="black" />
  </svg>
    `

      const  k  =   `
  <svg height="76" class="piece white" width="76" xmlns="http://www.w3.org/2000/svg" id="circle">
    <circle cx="38" cy="38" r="35" stroke="black" stroke-width="3" fill="white" />
  </svg>

    `
      const t =   `


  <svg height="76" class="piece white" width="76" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="38,3 73,73 3,73" stroke="black" stroke-width="3" fill="white" />
  </svg>
    `

      const kK = `
      <div style="display: flex; justify-content: center; align-content: center;">
<svg height="38" class="piece white" width="38" xmlns="http://www.w3.org/2000/svg" id="circle">
   <circle cx="19" cy="19" r="17" stroke="black" stroke-width="3" fill="white" />
</svg>
<svg height="38" class="piece black" width="38" xmlns="http://www.w3.org/2000/svg" id="circle">
  <circle cx="19" cy="19" r="17" stroke="white" stroke-width="3" fill="black" />
</svg>
</div>
      `
      const kT = `
      <div style="display: flex; justify-content: center; align-content: center;">
<svg height="38" class="piece white" width="38" xmlns="http://www.w3.org/2000/svg" id="circle">
   <circle cx="19" cy="19" r="17" stroke="black" stroke-width="3" fill="white" />
</svg>
  <svg height="38" class="piece black" width="38" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="19,3 35,35 3,35" stroke="white" stroke-width="3" fill="black" />
  </svg>
</div>
      `
    const tK = `
    <div style="display: flex; justify-content: center; align-content: center;">
  <svg height="38" class="piece white" width="38" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="19,3 35,35 3,35" stroke="black" stroke-width="3" fill="white" />
  </svg>
<svg height="38" class="piece black" width="38" xmlns="http://www.w3.org/2000/svg" id="circle">
   <circle cx="19" cy="19" r="17" stroke="white" stroke-width="3" fill="black" />
</svg>

</div>
    `
    const tT = `
    <div style="display: flex; justify-content: center; align-content: center;">
  <svg height="38" class="piece white" width="38" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="19,3 35,35 3,35" stroke="black" stroke-width="3" fill="white" />
  </svg>
  <svg height="38" class="piece black" width="38" xmlns="http://www.w3.org/2000/svg" id="triangle">
    <polygon points="19,3 35,35 3,35" stroke="white" stroke-width="3" fill="black" />
  </svg>

</div>

    `




    




      newhtml = `
      <div id="popup" class="popup">
  <h2 id="gameOverText"></h2>
  <p id="descriptionText"></p>
  <p id="revengeText">No mo≈æete tra≈æiti revan≈æ...</p>
  <button onclick="revenge()" id="revenge">Revan≈æ</button>
  <button onclick="closePopup()">U redu</button>
</div>
      <div class="centered" style="max-width: 100%;   width: 100vw;
  height: 100vh;">
        <div style="text-align: center;">

        <div style="display:flex;width:100%;justify-content: space-between;"> 
          <div style="display:flex; ">
    
            <img class="gameProfile" src="/image/${whitePlayer}">
            </div>
            <div style="margin-left: 5px; flex:1; display:flex;flex-direction: column;align-items: center;justify-content: center;">
              <p style="margin: 0" id="whitePlayer">${whitePlayer}</p>        
              <p style="margin: 0" id="false">0:00</p>
         </div>
            
    
    <div style=" flex:1;">
<p style="margin-top: 0px;margin-bottom: 5px;" id="gameTitle">${gameId}</p>
<h2 id="scoreboard" style="margin-bottom: 0;margin-top: 5px;">0 - 0</h2>
<p style="margin-top: 0px;margin-bottom: 0px;" id="moveCounter">Potez: 0</p>
    </div>      

          
          
                <div style="flex:1;margin-right: 5px; display:flex;flex-direction: column;align-items: center;justify-content: center;">
              <p style="margin: 0" id="blackPlayer">${blackPlayer}</p>        
              <p style="margin: 0" id="true">0:00</p>
         </div>

         <div style=" ">
            <img class="gameProfile" src="/image/${blackPlayer}">

            
    </div>
          </div>
       <div id="gameGrid"></div>
       <div id="initialPieces" style="display:flex;width:100%;justify-content: center; gap:10px;"></div>
       </div>
  <div style="display: flex;flex-direction: row;gap: 66px;">

  <button class="actionButton" id="giveUp" style="float:left;">üè≥Ô∏è</button>

  <button class="actionButton" id="confirmMove" style="float:right; disabled">üö´</button>
</div>
`;
  document.body.innerHTML = newhtml;
  counter = 0;
  moveCounter = document.getElementById("moveCounter");
  scoreboard = document.getElementById("scoreboard");
  socket.on("revengeWanted", (data) => {
    if (data.requestee != isBlack){
      document.getElementById("revengeText").innerHTML = "Va≈° protivnik ≈æeli revan≈æ...";
    }
  });
 function attachListeners(){

  document.querySelectorAll(".piece").forEach(element => {

                  
                  element.addEventListener("click", (event) => { 
                    document.addEventListener("click", (event) => {
                      if (!event.target.closest(".cell")) {
                        if (selectedElement) {
                          selectedElement.innerHTML = selectedElement.innerHTML.replace('<rect width="76" height="76" fill="#ef9"></rect>', "");
                          selectedElement = undefined;
                          selectedPiece = undefined;
                          clearSelections();
                        }
                      }
                    });
                    if (selectedElement && !element.classList.contains(isBlack ? "black" : "white")) {
                      return; // Do nothing if an element is already selected or if the clicked piece is not my color
                    }
                    event.stopPropagation()
                                        console.log("KLIKNUO SAM NA KOMAD");
                    pieceIsBlack = element.classList.contains("black") ? true : false;
                    if(pieceIsBlack == isBlack){
                      console.log(`KLIKNUO SAM NA ${element.id} MOJE BOJE`);

                  
                    if (selectedElement !== undefined){
              console.log("SELECTED VEƒÜ POSTOJI");
              console.log(selectedElement.innerHTML);
              selectedElement.innerHTML = selectedElement.innerHTML.replace('<rect width="76" height="76" fill="#ef9"></rect>',"");
              
            }
            selectedElement = element;
            selectedPiece = element.id;
            selectedId = element.closest(".cell").id;
            element.innerHTML = '<rect width="76" height="76" fill="#ef9"></rect>'+element.innerHTML;
            console.log(element.id);
            console.log(selectedId);
            console.log("OVO TU JE ID NAJBLI≈ΩEG CELL ASRANJE ASAFDSADSDS");
            console.log(element.getAttribute("index"));
            console.log(typeof element.getAttribute("index"));
            //coerce to number
            

              console.log(movesOfPieces[+element.getAttribute("index")]);
              colorAllowedMoves(movesOfPieces[+element.getAttribute("index")]);
              
                }});
                });
            

            document.querySelectorAll(".cell").forEach(element => {
                element.addEventListener("click", () => {
                if (element.querySelectorAll(".piece").length >= 2) {
                  console.log("Cannot place more than 2 pieces on a cell.");
                  return;
                }
                  console.log("KLIKNUO SAM NA ƒåELL");
                  playerMoves = moves[+isBlack];
                  if (selectedElement !== undefined){
                    for(i = 0; i < 35; i++){
        document.getElementById(i.toString()).style = "";
      }
                  
      let indexAttributes = {};

for (let index = 0; index < 4; index++) {
    let position = moves[+isBlack][index];
    if (position !== -1) {
        let parentDiv = document.getElementById(position.toString());
        let targetSvg = parentDiv.querySelector(isBlack ? "svg.black" : "svg.white");
        if (targetSvg) {
            indexAttributes[position] = targetSvg.getAttribute("index");
        }
    }
}
                  if (movesOfPieces[+selectedElement.getAttribute("index")].includes(element.id)){
                    console.log(moves[+isBlack]);
                    let oldPosition = selectedId.toString();
                    let newPosition = element.id;
                    moves[+isBlack][moves[+isBlack].indexOf(oldPosition)] = newPosition;
                    // Step 3: Update the indexAttributes with the new positions
            if (indexAttributes[oldPosition]) {
                indexAttributes[newPosition] = indexAttributes[oldPosition];
                delete indexAttributes[oldPosition];
            }
                    console.log(moves[+isBlack]);

                  }
                  
                    console.log(selectedElement)
                    console.log("AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA");
                    selectedElement.innerHTML = selectedElement.innerHTML.replace('<rect width="76" height="76" fill="#ef9"></rect>',"");
                    selectedElement = undefined;
                    selectedPiece = undefined;
                  
                   
                    updateBoard();
                    setTimeout(() => {
    document.querySelectorAll(".cell").forEach(element => {
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
              });
              document.querySelectorAll(".piece").forEach(element => {
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
              });
  }, 0);


                    setTimeout(() =>{
attachListeners();
            }, 0);
                    for (let index = 0; index < 4; index++) {
    let position = moves[+isBlack][index];
    if (position !== -1) {
        let parentDiv = document.getElementById(position.toString());
        let targetSvg = parentDiv.querySelector(isBlack ? "svg.black" : "svg.white");
        if (targetSvg && indexAttributes[position]) {
            targetSvg.setAttribute("index", indexAttributes[position]);
        }
    }
}
                    
                    
                  

                  }
                  
                
                });
              });
            }

  startTimer(timerLeft);
  startTimer(timerRight);
  var confirmButton = document.getElementById("confirmMove");
  var giveUpButton = document.getElementById("giveUp");
  givingUp = 0;
  gaveUp = false;

//capture every click
document.addEventListener("click", (event) => {
  if (event.target == giveUpButton){
    if (gaveUp){
      giveUpButton.innerHTML = ":(";
      giveUpButton.style = "background-color: #a00; border 1px solid #800";
    }
    else{
    givingUp++;
    if (givingUp == 1){
      giveUpButton.innerHTML = "‚ÅâÔ∏è";
      giveUpButton.style = "background-color: #a00; border 1px solid #800";
    }
    if (givingUp == 2){
      giveUpButton.innerHTML = ":(";
      gaveUp = true;
      console.log("eto odusta si bravo bogte");
      socket.emit("giveUp",{"id":gameId,"isBlack":isBlack});
    }
  }
  }
  else if (event.target != giveUpButton && gaveUp != true){
    givingUp = 0;
    giveUpButton.innerHTML = "üè≥Ô∏è"
    giveUpButton.style = "";

  }
});

socket.on("gameOver", (data) => {
  stopTimer(timerLeft);
  stopTimer(timerRight);
  console.log(data.loserIsBlack);
  if (data.loserIsBlack == isBlack){
    document.getElementById("gameOverText").innerHTML = "Izgubili ste.";
    document.getElementById("descriptionText").innerHTML = "Igra je do≈°la do kraja po bodovima.";
  }
  else{
    document.getElementById("gameOverText").innerHTML = "Pobjedili ste!";
    document.getElementById("descriptionText").innerHTML = "ƒåestitamo!";
  }
  if(data.reason == "gaveUp"){
    document.getElementById("descriptionText").innerHTML = "Igra je zavr≈°ila predajom.";
  }
  else if (data.reason == "userLeft"){
    document.getElementById("descriptionText").innerHTML = "Protivnik je napustio igru.";
    document.getElementById("revenge").style.display = "none";
    document.getElementById("revengeText").style.display = "none";
  }
  document.getElementById("popup").style.display = "block";
});



  

const gridDisplay = document.getElementById("gameGrid");  
let initialPieces = document.getElementById("initialPieces");
var nameLeft = document.getElementById("whitePlayer");
var nameRight = document.getElementById("blackPlayer");

socket.on("waiting",  (data) => {


console.log(data.whoIsDone);
if (data.whoIsDone){
  stopTimer(timerRight);
  nameRight.innerHTML = `‚úÖ ${blackPlayer}`;
  
}   
else{
  stopTimer(timerLeft);
  nameLeft.innerHTML = `${whitePlayer} ‚úÖ`;
}

  

//tu ƒáemo djelovati kad se ƒçeka na nama
//ovo ne radi i ne znam za≈°to

//trebao sam izvaditi 
//socket.on
//iz submitMovea
//i sad radi


//za≈°to ne radi u submitMoveu ne znam
//ali sad radi
//i to je to
// ^^^  ovo je napisao copilot 



});
  
    initialPieces.innerHTML= (isBlack ? K : k).repeat(2)+ (isBlack ? T : t).repeat(2);
    socket.onAny((eventName, ...args) => {
      console.log(eventName);
      console.log(args);
});


window.addEventListener("beforeunload", function (e){
  socket.emit("giveUp",{"id":gameId,"isBlack":isBlack,"userLeft":true});
})

for (let i = 0; i < 35; i++) {
      
        const cell = document.createElement("div");
        cell.classList.add("cell");
        cell.id = ''+i;
        if (["7", "8", "9", "14", "15", "16", "21", "22", "23"].includes(""+i)) {
          cell.classList.add("restricted-left");
        }
        if (["11", "12", "13", "18", "19", "20", "25", "26", "27"].includes(""+i)) {
          cell.classList.add("restricted-right");
        }


        gridDisplay.appendChild(cell);
      

    }

      disableConfirmButton = function(){
        confirmButton.disabled = true;
        confirmButton.innerHTML = "üö´";
      }
      enableConfirmButton = function(){
        confirmButton.disabled = false;
        confirmButton.innerHTML = "‚úÖ"
      }
      var nameLeft = document.getElementById("whitePlayer");
      var nameRight = document.getElementById("blackPlayer");
      whiteScore = 0;
      blackScore = 0;
    submitMove = function(){
      vrijeme1 = new Date();
     

      isBlack ? nameRight.innerHTML =  `‚úÖ ${blackPlayer}` : nameLeft.innerHTML = `${whitePlayer} ‚úÖ`;
      stopTimer(isBlack ? timerRight : timerLeft);
     

      disableConfirmButton();
        
        //TODO: napravit
        movesforSubmitting = moves[+isBlack];
        console.log(movesforSubmitting);
        //socket.off("waiting");
        socket.off("ok");
        socket.emit("submitMoves",{"id":gameId,"isBlack":isBlack,"moves":movesforSubmitting,"time":vrijeme1 - vrijeme2});
        //socket.off("waiting");

      
        socket.on("ok", (data) => {
          vrijeme2 = new Date();
          counter++;
          moveCounter.innerHTML = `Potez: ${counter}`;
          whiteScore += data.whiteTaken.length;
          blackScore += data.blackTaken.length;
          scoreboard.innerHTML = `${whiteScore} - ${blackScore}`;
          nameLeft.innerHTML = whitePlayer;
          nameRight.innerHTML = blackPlayer;
          movesOfPieces = [];

           //TODO: ovdje zapoƒçeti tajmere
           startTimer(timerLeft);
           startTimer(timerRight);


            if (isFirstMove){
              document.querySelectorAll(".cell").forEach(element => {
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
              });
              document.querySelectorAll(".piece").forEach(element => {
                const newElement = element.cloneNode(true);
                element.parentNode.replaceChild(newElement, element);
              });
              setTimeout(() =>{
attachListeners();
            }, 0);
        
              console.log("OVO JE PRVI POTEZ BIO");
   
              //document.querySelectorAll()
              isFirstMove = false;
              illegalMoves = [];

              //TODO: GFPKK

            }
            
            // Check if any piece starts the move while overlapped with another


            //ako smo mi drugi poslali na≈°e pokrete
            moves = data.moves;
            //remove restricred classes from cells
            document.querySelectorAll(".cell").forEach(cell => {
              cell.classList.remove("restricted-left", "restricted-right");
            });
            // for (i = 0; i < 35; i++){
            //   document.getElementById(i.toString()).className	= "cell";
            // }
            for (i of data.whiteTaken){
              document.getElementById(i.toString()).className = "cell white taken"
              illegalMoves.push(i);
            }
            for (i of data.blackTaken){
              document.getElementById(i.toString()).className = "cell black taken"
              illegalMoves.push(i);
            }
            updateBoard();
            for (let i = 0; i < 4; i++) {
              console.log("gledam")
              let position = moves[+isBlack][i];
              if (position !== -1 && position !== -2) {
                let cell = document.getElementById(position.toString());
                console.log(`na ${position} ih ima ${cell.querySelectorAll(".piece").length}`);
                if (cell.querySelectorAll(".piece").length > 1) {
                  let allowedMoves = computeAllowedMoves(position);
                  let onlyMoveIntoSameColor = allowedMoves.every(move => {
                    let targetCell = document.getElementById(move);
                    return targetCell.querySelector(isBlack ? ".black" : ".white");
                  });
                  if (onlyMoveIntoSameColor) {
                    moves[+isBlack][i] = -1;
                  }
                  else{
                    console.log(`pa, vi≈°e ih je ali smije se! na poziciji ${position}`);
                  }
                }
              }
            }
            updateBoard();
            //get index for each piec
            console.log(moves);
            console.log(moves[+isBlack]);
            console.log("ASDFGHJKLSDFGHJKL");
          
            for (let index = 0; index < 4; index++) {
    let position = moves[+isBlack][index];
    if (position !== -1) {
        console.log(`Processing piece ${index} at position ${position}`);
        
        movesOfPieces.push(computeAllowedMoves(position));
        let parentDiv = document.getElementById(position.toString());
        
        // Debugging statements
        console.log(`Parent div for position ${position}:`, parentDiv);
        
        let targetSvg = parentDiv.querySelector(isBlack ? "svg.black" : "svg.white");
        
        // More debugging statements
        console.log(`Query selector used: ${isBlack ? "svg.black" : "svg.white"}`);
        console.log(`Target SVG for position ${position}:`, targetSvg);
        
        if (targetSvg) {
            targetSvg.setAttribute("index", (movesOfPieces.length - 1).toString());
        } else {
            console.warn(`No SVG found for position ${position} with selector ${isBlack ? "svg.black" : "svg.white"}`);
        }
    }
}
            window.movesOfPieces = movesOfPieces;
           

        });
       }

    colorAllowedMoves = function(moves){
      for(i = 0; i < 35; i++){
        document.getElementById(i.toString()).style = "";
      }

        for (var id of moves){
          //id = id.padStart(2,"0");

          document.getElementById(id).style="border: 2px solid #090;";

        }
      }

      computeAllowedMoves = function(position=0){
        let allowedMoves = [];
        //convert position to number
        position = +position;

        
        if (isFirstMove){

          
          for (let i = 0; i < 35; i++){
            if (illegalMoves.includes(i.toString()) == false){

              allowedMoves.push(i.toString());
              
            }
          }
          
        }
        else {

          transforms = [
                -7,  
                 0,  
                 7,  
          ]
          
          position % 7 == 0 ? null : transforms.push(6,-1,-8); //add to transforms left edge moves
          position % 7 == 6 ? null : transforms.push(1,-6,8) ; 

          for (i = 0; i < transforms.length; i++){
          let newPosition = +position + transforms[i];



          
          if(newPosition > -1 && newPosition < 35 && !document.getElementById(newPosition.toString()).classList.contains("taken")){ 
            allowedMoves.push(newPosition.toString());
          }
        }


        }
        console.log(allowedMoves);
        return allowedMoves;
      }

      // ≈°to ako su dva na jednom mjestu?!?!?!? 
      // kK  b
      // kT  c
      // tK  c
      // tT  b
      socket.emit("listenIn",{"id":gameId,"isBlack":isBlack});

      
      updateBoard = function(){
        shouldEnable = true;
        myPieces = moves[+isBlack];
        for (i of myPieces){
          if (i !== -1 && i !== -2){
          if (document.getElementById(i.toString()).classList.contains("taken")){
            console.log("SAD NEƒÜU ENABLEAT");
            shouldEnable = false;
          }}
        
        }
       


        lookupTable = {
          "k": k,
          "t": t,
          "K": K,
          "T": T,
          "kK": kK,
          "kT": kT,
          "tK": tK,
          "tT": tT,

          
          
        }

        for (i = 0; i < 35; i++){
          document.getElementById(i.toString()).innerHTML = "";
        }
        let result = {};

        for (let i = 0; i < moves[0].length; i++) {
  let lowerMove = moves[0][i];
  if (i < 2){
  if (lowerMove !== -1 && lowerMove !== -2) { // Skip if the number is -1
    if (!result[lowerMove]) {
      result[lowerMove] = "k"; // Assign "k" for lowercase piece
    } else {
      result[lowerMove] += "k"; // Add another "k" if already exists
    }
  }
}
else{
  if (lowerMove !== -1 && lowerMove !== -2) { // Skip if the number is -1
    if (!result[lowerMove]) {
      result[lowerMove] = "t"; // Assign "k" for lowercase piece
    } else {
      result[lowerMove] += "t"; // Add another "k" if already exists
    }
  }
}
}

// Process uppercase pieces
for (let i = 0; i < moves[1].length; i++) {
  let upperMove = moves[1][i];
  if (i < 2){
  if (upperMove !== -1 && upperMove !== -2) { // Skip if the number is -1
    if (!result[upperMove]) {
      result[upperMove] = "K"; // Assign "k" for lowercase piece
    } else {
      result[upperMove] += "K"; // Add another "k" if already exists
    }
  }
}
else{
  if (upperMove !== -1 && upperMove !== -2) { // Skip if the number is -1
    if (!result[upperMove]) {
      result[upperMove] = "T"; // Assign "k" for lowercase piece
    } else {
      result[upperMove] += "T"; // Add another "k" if already exists
    }
  }
}
}

      for (id in result){
        if (["kk","tt","KT","TK"].includes(result[id])) {
          console.log("SAD NEƒÜU ENABLEAT ZATO ≈†TO SI STAVIO SVOJA DVA NA JEDNO TE ISTO MJESTO");
    shouldEnable = false;
}
        console.log(`${id}: ${result[id]}`);
        document.getElementById(id.toString()).innerHTML = lookupTable[result[id]];
      }
      shouldEnable ? enableConfirmButton() : disableConfirmButton();
      !isFirstMove ? attachListeners() : null;
    }
    

      clearSelections = function(){
        for (i = 0; i < 35; i++){
          document.getElementById(i.toString()).style = "";
        }
      }

      //ovo radi
      document.querySelectorAll(".piece").forEach(element => {
        element.addEventListener("click", () =>{
          console.log(`KLIKNUO SAM NA ${element.id}`);
          if (selectedElement !== undefined){
            console.log("SELECTED VEƒÜ POSTOJI");
            console.log(selectedElement.innerHTML);
            selectedElement.innerHTML = selectedElement.innerHTML.replace('<rect width="76" height="76" fill="#ef9"></rect>',"");
            
          }
          selectedElement = element;
          selectedPiece = element.id;
          element.innerHTML = '<rect width="76" height="76" fill="#ef9"></rect>'+element.innerHTML;
          colorAllowedMoves(computeAllowedMoves());
        });
      });

      document.querySelectorAll(".cell").forEach(element => {
        element.addEventListener("click", () => {
          console.log("klikitis");
          console.log(element.id);
          if (selectedElement !== undefined && computeAllowedMoves().includes(element.id)){

            playerMoves = moves[+isBlack];

            if (selectedPiece == "circle") {
    // Try to place the circle in the first two available spots (index 0 or 1)
    if (playerMoves[0] === -2) {
      playerMoves[0] = element.id; // Place circle in the first empty spot
    } else if (playerMoves[1] === -2) {
      playerMoves[1] = element.id; // Place circle in the second empty spot
    }
  } else if (selectedPiece == "triangle") {
    // Try to place the triangle in the last two available spots (index 2 or 3)
    if (playerMoves[2] === -2) {
      playerMoves[2] = element.id; // Place triangle in the first empty spot
    } else if (playerMoves[3] === -2) {
      playerMoves[3] = element.id; // Place triangle in the second empty spot
    }
  }
          illegalMoves.push(element.id);
          clearSelections();
          updateBoard();
          a++;
          if (a == 4){
            a = -Infinity
            enableConfirmButton();
            confirmButton.onclick = function() {submitMove()};
          }
          else{
            disableConfirmButton();
          }
          selectedElement.remove();
          selectedElement = undefined;
          selectedPiece = undefined;
          }
        });
      });

    });

  });


</script>
<!--<script src="{{ url_for('static',filename='kontranto.js') }}"></script>
-->
</html>